<!DOCTYPE html>
<html>
<head>
  <title>高级图片管理工具 - 改进版</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { display: flex; gap: 20px; margin-bottom: 20px; }
    .config-box { background: #f5f5f5; padding: 15px; border-radius: 5px; flex: 1; }
    textarea { width: 100%; height: 150px; margin: 10px 0; }
    button { padding: 8px 15px; background: #007bff; color: white; border: none; cursor: pointer; }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .img-card { border: 2px solid #ddd; padding: 10px; position: relative; cursor: pointer; transition: all 0.2s; }
    .img-card.selected { border-color: #007bff; box-shadow: 0 0 8px rgba(0,123,255,0.3); }
    .img-card img { max-width: 100%; height: auto; display: block; }
    .checkbox { position: absolute; top: 5px; right: 5px; }
    .size-info { font-size: 12px; color: #666; margin-top: 5px; }
    .stats { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    .stats span { margin-right: 20px; font-weight: bold; }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }
    .progress-container {
      width: 80%;
      max-width: 500px;
      background: #ddd;
      border-radius: 5px;
      margin-top: 20px;
    }
    .progress-bar {
      height: 20px;
      background: #4CAF50;
      border-radius: 5px;
      width: 0%;
      transition: width 0.3s;
    }
    .drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      transition: all 0.3s;
    }
    .drop-area.highlight {
      border-color: #007bff;
      background: rgba(0,123,255,0.1);
    }
    .tab-container {
      display: flex;
      margin-bottom: 10px;
    }
    .tab {
      padding: 8px 15px;
      background: #e9ecef;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background: #007bff;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h2>高级图片管理工具</h2>
  <div class="stats" id="stats">
    <span>总图片数: 0</span>
    <span>符合条件: 0</span>
    <span>当前剩余: 0</span>
  </div>

  <div class="container">
    <div class="config-box">
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('html-tab')">HTML输入</div>
        <div class="tab" onclick="switchTab('url-tab')">URL输入</div>
      </div>
      
      <div id="html-tab" class="tab-content active">
        <div class="drop-area" id="dropArea">
          <p>拖放HTML文件到这里或粘贴HTML代码</p>
          <textarea id="htmlInput" placeholder="粘贴完整的HTML内容到这里..."></textarea>
        </div>
        <button onclick="loadImages()">解析图片</button>
      </div>
      
      <div id="url-tab" class="tab-content">
        <input type="text" id="urlInput" placeholder="输入网页URL" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button onclick="fetchFromUrl()">获取网页内容</button>
      </div>
    </div>
    
    <div class="config-box">
      <h3>步骤 2：筛选设置</h3>
      <div>
        <label>最小宽度: <input type="number" id="minWidth" value="0"></label>
        <label style="margin-left: 10px;">最小高度: <input type="number" id="minHeight" value="0"></label>
        <button onclick="applyFilter()" style="margin-left: 10px;">应用筛选</button>
      </div>
      
      <h3 style="margin-top: 15px;">图片属性设置</h3>
      <div>
        <label>解析属性: 
          <input type="text" id="attrInput" value="data-original" placeholder="例如: data-original,src">
        </label>
        <small>多个属性用逗号分隔</small>
      </div>
      
      <h3 style="margin-top: 15px;">操作</h3>
      <div>
        <button onclick="deleteSelected()">删除选中项</button>
        <button onclick="copyResults()" style="margin-left: 10px;">复制结果</button>
      </div>
    </div>
  </div>

  <div id="gallery"></div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div id="loadingText">加载中...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="progressText">0/0</div>
  </div>

  <script>
    let allImages = [];
    let currentFiltered = [];

    // 切换标签页
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // 设置拖放功能
    const dropArea = document.getElementById('dropArea');
    const htmlInput = document.getElementById('htmlInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.classList.add('highlight');
    }

    function unhighlight() {
      dropArea.classList.remove('highlight');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        const file = files[0];
        if (file.type === 'text/html' || file.name.endsWith('.html')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            htmlInput.value = e.target.result;
          };
          reader.readAsText(file);
        } else {
          alert('请上传HTML文件');
        }
      }
    }

    // 从URL获取网页内容
    async function fetchFromUrl() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('请输入有效的URL');
        return;
      }

      showLoading(true, '正在获取网页内容...');
      
      try {
        // 使用CORS代理绕过跨域限制
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        const response = await fetch(proxyUrl);
        const data = await response.json();
        
        if (data.contents) {
          htmlInput.value = data.contents;
          loadImages();
        } else {
          throw new Error('无法获取网页内容');
        }
      } catch (error) {
        alert('获取网页内容失败: ' + error.message);
        console.error(error);
      } finally {
        showLoading(false);
      }
    }

    // 加载图片
    async function loadImages() {
      const html = htmlInput.value;
      if (!html) {
        alert('请输入HTML内容');
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      allImages = [];
      currentFiltered = [];
      document.getElementById('gallery').innerHTML = '';
      
      // 获取要解析的属性
      const attrInput = document.getElementById('attrInput').value;
      const attributes = attrInput.split(',').map(attr => attr.trim()).filter(attr => attr);
      
      if (attributes.length === 0) {
        alert('请至少指定一个要解析的属性');
        return;
      }

      showLoading(true, '正在解析图片...');
      
      // 收集所有指定属性的图片URL
      let elements = [];
      attributes.forEach(attr => {
        elements = elements.concat(Array.from(doc.querySelectorAll(`[${attr}]`)));
      });
      
      const links = [...new Set(elements.map(el => {
        for (const attr of attributes) {
          if (el.hasAttribute(attr)) {
            return el.getAttribute(attr);
          }
        }
        return null;
      }).filter(url => url))];
      
      if (links.length === 0) {
        alert('没有找到符合条件的图片');
        showLoading(false);
        return;
      }

      // 更新进度条
      updateProgress(0, links.length);
      
      // 异步加载图片获取尺寸
      for (let i = 0; i < links.length; i++) {
        const url = links[i];
        try {
          await loadImageWithProgress(url, i, links.length);
        } catch (error) {
          console.error(`加载图片失败: ${url}`, error);
          allImages.push({
            url,
            width: 0,
            height: 0,
            selected: false,
            error: true
          });
        }
      }

      currentFiltered = allImages.slice();
      applyFilter();
      showLoading(false);
    }

    // 带进度条的图片加载
    function loadImageWithProgress(url, current, total) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = url;
        
        img.onload = () => {
          allImages.push({
            url,
            width: img.naturalWidth,
            height: img.naturalHeight,
            selected: false,
            error: false
          });
          updateProgress(current + 1, total);
          resolve();
        };
        
        img.onerror = () => {
          allImages.push({
            url,
            width: 0,
            height: 0,
            selected: false,
            error: true
          });
          updateProgress(current + 1, total);
          resolve();
        };
        
        // 设置超时
        setTimeout(() => {
          if (!img.complete) {
            allImages.push({
              url,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
            updateProgress(current + 1, total);
            resolve();
          }
        }, 10000);
      });
    }

    // 更新进度条
    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `${current}/${total}`;
      document.getElementById('loadingText').textContent = `正在加载图片 (${percent}%)`;
    }

    // 渲染图片库
    function renderGallery(images) {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = images.map((img, index) => `
        <div class="img-card ${img.selected ? 'selected' : ''} ${img.error ? 'error' : ''}" 
             onclick="toggleSelect(${index}, event)">
          <input type="checkbox" class="checkbox" 
                 ${img.selected ? 'checked' : ''} 
                 onchange="toggleSelect(${index})">
          <img src="${img.url}" alt="缩略图" onerror="this.style.display='none'">
          <div class="size-info">
            ${img.width}x${img.height || '未知'}
            ${img.error ? '<span style="color:red">(加载失败)</span>' : ''}
          </div>
        </div>
      `).join('');
      updateStats();
    }

    // 应用筛选
    function applyFilter() {
      const minW = parseInt(document.getElementById('minWidth').value) || 0;
      const minH = parseInt(document.getElementById('minHeight').value) || 0;
      
      currentFiltered = allImages.filter(img => 
        img.width >= minW && img.height >= minH
      );
      renderGallery(currentFiltered);
    }

    // 切换选择状态
    function toggleSelect(index, event) {
      if (event) event.stopPropagation();
      currentFiltered[index].selected = !currentFiltered[index].selected;
      
      // 同步到总数据
      const targetUrl = currentFiltered[index].url;
      const mainIndex = allImages.findIndex(img => img.url === targetUrl);
      if (mainIndex >= 0) {
        allImages[mainIndex].selected = currentFiltered[index].selected;
      }
      
      renderGallery(currentFiltered);
    }

    // 删除选中项
    function deleteSelected() {
      const selectedUrls = currentFiltered
        .filter(img => img.selected)
        .map(img => img.url);
      
      allImages = allImages.filter(img => 
        !selectedUrls.includes(img.url)
      );
      applyFilter();
    }

    // 复制结果
    function copyResults() {
      const links = currentFiltered.map(img => img.url);
      navigator.clipboard.writeText(links.join('\n')).then(() => {
        alert(`已复制 ${links.length} 个链接到剪贴板！`);
      });
    }

    // 更新统计信息
    function updateStats() {
      const total = allImages.length;
      const visible = currentFiltered.length;
      document.getElementById('stats').innerHTML = `
        <span>总图片数: ${total}</span>
        <span>符合条件: ${visible}</span>
        <span>当前剩余: ${visible}</span>
      `;
    }

    // 显示/隐藏加载状态
    function showLoading(show, message = '加载中...') {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
      document.getElementById('loadingText').textContent = message;
    }
  </script>
</body>
</html>
