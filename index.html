<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高级图片管理工具 - 微信兼容版</title>
  <style>
    :root {
      --primary-color: #07C160; /* 微信风格绿色 */
      --secondary-color: #576B95; /* 微信辅助色 */
      --light-bg: #F7F7F7;
      --dark-bg: #1A1A1A;
      --text-color: #333333;
      --border-color: #E6E6E6;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 15px;
      color: var(--text-color);
      line-height: 1.6;
      max-width: 100%;
      margin: 0 auto;
      background-color: var(--light-bg);
    }
    
    h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .config-box {
      background: white;
      padding: 15px;
      border-radius: 12px;
      flex: 1;
      min-width: 300px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 15px;
    }
    
    button {
      padding: 12px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s;
      margin: 5px 0;
      font-weight: 500;
      width: 100%;
    }
    
    button:hover {
      background: #06AD56;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: var(--secondary-color);
    }
    
    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }
    
    .img-card {
      border: 1px solid var(--border-color);
      padding: 10px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
      background: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .img-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .img-card.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(7,193,96,0.2);
    }
    
    .img-card.error {
      border-color: #FA5151;
    }
    
    .img-card img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 6px;
    }
    
    .checkbox {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .size-info {
      font-size: 13px;
      color: #888;
      margin-top: 8px;
      text-align: center;
    }
    
    .stats {
      margin: 15px 0;
      padding: 12px;
      background: white;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .stats span {
      font-weight: 500;
      white-space: nowrap;
      color: var(--text-color);
    }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }
    
    .progress-container {
      width: 80%;
      max-width: 500px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      margin: 20px 0 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 6px;
      background: white;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
    
    .drop-area {
      border: 2px dashed var(--border-color);
      padding: 25px;
      text-align: center;
      margin: 10px 0;
      transition: all 0.3s;
      border-radius: 8px;
      background: rgba(255,255,255,0.5);
    }
    
    .drop-area.highlight {
      border-color: var(--primary-color);
      background: rgba(7,193,96,0.05);
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 15px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    
    .tab-container::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: 10px 20px;
      background: #EDEDED;
      cursor: pointer;
      border-radius: 8px;
      margin-right: 8px;
      white-space: nowrap;
      transition: all 0.2s;
      font-size: 15px;
      color: #666;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    input[type="text"], input[type="number"] {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 5px 0;
      width: 80px;
      font-size: 15px;
    }
    
    label {
      margin-right: 10px;
      white-space: nowrap;
      font-size: 15px;
    }
    
    .actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .container {
        flex-direction: column;
        gap: 12px;
      }
      
      .config-box {
        width: 100%;
        min-width: auto;
        padding: 12px;
      }
      
      #gallery {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }
      
      .tab {
        padding: 8px 16px;
        font-size: 14px;
      }
      
      button {
        padding: 10px;
        font-size: 14px;
      }
    }
    
    /* 暗黑模式 */
    @media (prefers-color-scheme: dark) {
      :root {
        --light-bg: #1A1A1A;
        --text-color: #F0F0F0;
        --border-color: #333;
      }
      
      body {
        background: #1A1A1A;
      }
      
      .config-box, .img-card, .stats {
        background: #222;
      }
      
      textarea, input[type="text"], input[type="number"] {
        background: #333;
        color: white;
        border-color: #444;
      }
      
      .drop-area {
        background: rgba(51, 51, 51, 0.5);
      }
      
      .tab {
        background: #333;
        color: #CCC;
      }
      
      .tab.active {
        color: white;
      }
      
      .size-info {
        color: #AAA;
      }
    }
  </style>
</head>
<body>
  <h2>高级图片管理工具</h2>
  <div class="stats" id="stats">
    <span>总图片数: 0</span>
    <span>符合条件: 0</span>
    <span>选中: 0</span>
  </div>

  <div class="container">
    <div class="config-box">
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('html-tab')">HTML输入</div>
        <div class="tab" onclick="switchTab('url-tab')">URL输入</div>
      </div>
      
      <div id="html-tab" class="tab-content active">
        <div class="drop-area" id="dropArea">
          <p>拖放HTML文件到这里或粘贴HTML代码</p>
          <textarea id="htmlInput" placeholder="粘贴完整的HTML内容到这里..."></textarea>
        </div>
        <button onclick="loadImages()">解析图片</button>
      </div>
      
      <div id="url-tab" class="tab-content">
        <input type="text" id="urlInput" placeholder="输入网页URL (包括微信文章)" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px;">
        <div class="actions">
          <button onclick="fetchFromUrl()">获取网页内容</button>
          <button class="secondary" onclick="testWechatUrl()">测试微信文章</button>
        </div>
      </div>
    </div>
    
    <div class="config-box">
      <h3>筛选设置</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px;">
        <label>最小宽度: <input type="number" id="minWidth" value="0" min="0"></label>
        <label>最小高度: <input type="number" id="minHeight" value="0" min="0"></label>
        <button onclick="applyFilter()" style="width: auto; padding: 10px 15px;">应用筛选</button>
      </div>
      
      <h3>图片属性设置</h3>
      <div style="margin-bottom: 15px;">
        <input type="text" id="attrInput" value="data-src,src,data-original" placeholder="例如: data-src,src" style="width: 100%; padding: 12px; border-radius: 8px;">
        <small>多个属性用逗号分隔，将按顺序尝试获取</small>
      </div>
      
      <h3>操作</h3>
      <div class="actions">
        <button onclick="selectAll()">全选</button>
        <button onclick="deselectAll()">取消全选</button>
        <button onclick="deleteSelected()" style="background: #FA5151;">删除选中</button>
        <button onclick="copyResults()">复制结果</button>
      </div>
    </div>
  </div>

  <div id="gallery"></div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div id="loadingText" style="font-size: 17px; margin-bottom: 15px; font-weight: 500;">加载中...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="progressText" style="margin-top: 15px; font-size: 14px;">0/0</div>
    <button onclick="cancelLoading()" style="margin-top: 20px; background: #FA5151; width: auto; padding: 10px 20px;">取消</button>
  </div>

  <script>
    let allImages = [];
    let currentFiltered = [];
    let loadingCanceled = false;
    let currentLoadingProcess = null;

    // 切换标签页
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // 设置拖放功能
    const dropArea = document.getElementById('dropArea');
    const htmlInput = document.getElementById('htmlInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.classList.add('highlight');
    }

    function unhighlight() {
      dropArea.classList.remove('highlight');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        const file = files[0];
        if (file.type === 'text/html' || file.name.endsWith('.html')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            htmlInput.value = e.target.result;
          };
          reader.readAsText(file);
        } else {
          alert('请上传HTML文件');
        }
      }
    }

    // 从URL获取网页内容（包括微信文章）
    async function fetchFromUrl() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('请输入有效的URL');
        return;
      }

      showLoading(true, '正在获取网页内容...');
      loadingCanceled = false;
      
      try {
        // 在微信环境中直接使用当前页面内容
        if (typeof WeixinJSBridge !== 'undefined') {
          // 微信内置浏览器环境
          if (confirm('检测到微信浏览器，将使用当前页面内容。请确保已打开目标文章页面。')) {
            htmlInput.value = document.documentElement.outerHTML;
            switchTab('html-tab');
            await loadImages();
            return;
          } else {
            showLoading(false);
            return;
          }
        }
        
        // 非微信环境使用CORS代理
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&callback=?`;
        
        currentLoadingProcess = fetch(proxyUrl, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
        });
        
        const response = await currentLoadingProcess;
        const data = await response.json();
        
        if (data.contents) {
          htmlInput.value = data.contents;
          switchTab('html-tab');
          await loadImages();
        } else {
          throw new Error('无法获取网页内容');
        }
      } catch (error) {
        if (!loadingCanceled) {
          alert('获取网页内容失败: ' + error.message);
          console.error(error);
          
          // 提供备选方案
          if (confirm('是否尝试打开网页手动复制内容？')) {
            window.open(url, '_blank');
          }
        }
      } finally {
        if (!loadingCanceled) {
          showLoading(false);
        }
        currentLoadingProcess = null;
      }
    }

    // 加载图片
    async function loadImages() {
      const html = htmlInput.value;
      if (!html) {
        alert('请输入HTML内容');
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      allImages = [];
      currentFiltered = [];
      document.getElementById('gallery').innerHTML = '';
      
      // 获取要解析的属性
      const attrInput = document.getElementById('attrInput').value;
      const attributes = attrInput.split(',').map(attr => attr.trim()).filter(attr => attr);
      
      if (attributes.length === 0) {
        alert('请至少指定一个要解析的属性');
        return;
      }

      showLoading(true, '正在解析图片...');
      loadingCanceled = false;
      
      // 收集所有指定属性的图片URL
      let elements = [];
      attributes.forEach(attr => {
        elements = elements.concat(Array.from(doc.querySelectorAll(`[${attr}]`)));
      });
      
      const links = [...new Set(elements.map(el => {
        for (const attr of attributes) {
          if (el.hasAttribute(attr)) {
            const url = el.getAttribute(attr);
            // 处理微信图片的URL（去掉协议部分可能存在的转义）
            return url.replace(/^https?:%2F%2F/, 'https://').replace(/^http:%2F%2F/, 'http://');
          }
        }
        return null;
      }).filter(url => url))];
      
      if (links.length === 0) {
        alert('没有找到符合条件的图片');
        showLoading(false);
        return;
      }

      // 更新进度条
      updateProgress(0, links.length);
      
      // 异步加载图片获取尺寸
      try {
        for (let i = 0; i < links.length; i++) {
          if (loadingCanceled) break;
          
          const url = links[i];
          try {
            await loadImageWithProgress(url, i, links.length);
          } catch (error) {
            console.error(`加载图片失败: ${url}`, error);
            allImages.push({
              url,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
          }
        }

        if (!loadingCanceled) {
          currentFiltered = allImages.slice();
          applyFilter();
        }
      } finally {
        showLoading(false);
      }
    }

    // 带进度条的图片加载
    function loadImageWithProgress(url, current, total) {
      return new Promise((resolve, reject) => {
        if (loadingCanceled) {
          reject(new Error('用户取消'));
          return;
        }

        const img = new Image();
        img.crossOrigin = "Anonymous"; // 尝试跨域请求
        
        // 处理微信图片可能的特殊URL
        let finalUrl = url;
        if (url.startsWith('//')) {
          finalUrl = 'https:' + url;
        } else if (url.startsWith('http%3A%2F%2F')) {
          finalUrl = decodeURIComponent(url);
        } else if (url.startsWith('data:')) {
          // 跳过Data URL
          allImages.push({
            url,
            width: 0,
            height: 0,
            selected: false,
            error: true
          });
          updateProgress(current + 1, total);
          return resolve();
        }
        
        img.src = finalUrl;
        
        img.onload = () => {
          if (loadingCanceled) return;
          
          allImages.push({
            url: finalUrl,
            width: img.naturalWidth,
            height: img.naturalHeight,
            selected: false,
            error: false
          });
          updateProgress(current + 1, total);
          resolve();
        };
        
        img.onerror = () => {
          if (loadingCanceled) return;
          
          // 尝试其他可能的URL格式
          if (!finalUrl.startsWith('http') && !finalUrl.startsWith('//')) {
            img.src = 'https://' + finalUrl;
            img.onerror = null;
            img.onload = () => {
              allImages.push({
                url: 'https://' + finalUrl,
                width: img.naturalWidth,
                height: img.naturalHeight,
                selected: false,
                error: false
              });
              updateProgress(current + 1, total);
              resolve();
            };
            img.onerror = () => {
              allImages.push({
                url: finalUrl,
                width: 0,
                height: 0,
                selected: false,
                error: true
              });
              updateProgress(current + 1, total);
              resolve();
            };
          } else {
            allImages.push({
              url: finalUrl,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
            updateProgress(current + 1, total);
            resolve();
          }
        };
        
        // 设置超时
        setTimeout(() => {
          if (!img.complete && !loadingCanceled) {
            allImages.push({
              url: finalUrl,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
            updateProgress(current + 1, total);
            resolve();
          }
        }, 10000);
      });
    }

    // 更新进度条
    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `${current}/${total} (${percent}%)`;
      document.getElementById('loadingText').textContent = `正在加载图片... ${percent}%`;
    }

    // 渲染图片库
    function renderGallery(images) {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = images.map((img, index) => `
        <div class="img-card ${img.selected ? 'selected' : ''} ${img.error ? 'error' : ''}" 
             onclick="toggleSelect(${index}, event)">
          <input type="checkbox" class="checkbox" 
                 ${img.selected ? 'checked' : ''} 
                 onchange="toggleSelect(${index})">
          <img src="${img.url}" alt="缩略图" onerror="this.style.display='none'">
          <div class="size-info">
            ${img.width}x${img.height || '未知'}
            ${img.error ? '<span style="color:#FA5151">(加载失败)</span>' : ''}
          </div>
        </div>
      `).join('');
      updateStats();
    }

    // 应用筛选
    function applyFilter() {
      const minW = parseInt(document.getElementById('minWidth').value) || 0;
      const minH = parseInt(document.getElementById('minHeight').value) || 0;
      
      currentFiltered = allImages.filter(img => 
        img.width >= minW && img.height >= minH
      );
      renderGallery(currentFiltered);
    }

    // 切换选择状态
    function toggleSelect(index, event) {
      if (event) event.stopPropagation();
      currentFiltered[index].selected = !currentFiltered[index].selected;
      
      // 同步到总数据
      const targetUrl = currentFiltered[index].url;
      const mainIndex = allImages.findIndex(img => img.url === targetUrl);
      if (mainIndex >= 0) {
        allImages[mainIndex].selected = currentFiltered[index].selected;
      }
      
      renderGallery(currentFiltered);
    }

    // 全选/取消全选
    function selectAll() {
      currentFiltered.forEach(img => img.selected = true);
      allImages.forEach(img => {
        if (currentFiltered.some(fImg => fImg.url === img.url)) {
          img.selected = true;
        }
      });
      renderGallery(currentFiltered);
    }

    function deselectAll() {
      currentFiltered.forEach(img => img.selected = false);
      allImages.forEach(img => {
        if (currentFiltered.some(fImg => fImg.url === img.url)) {
          img.selected = false;
        }
      });
      renderGallery(currentFiltered);
    }

    // 删除选中项
    function deleteSelected() {
      const selectedUrls = currentFiltered
        .filter(img => img.selected)
        .map(img => img.url);
      
      if (selectedUrls.length === 0) {
        alert('请先选择要删除的图片');
        return;
      }
      
      if (!confirm(`确定要删除选中的 ${selectedUrls.length} 张图片吗？`)) {
        return;
      }
      
      allImages = allImages.filter(img => 
        !selectedUrls.includes(img.url)
      );
      applyFilter();
    }

    // 复制结果
    function copyResults() {
      const links = currentFiltered.map(img => img.url);
      if (links.length === 0) {
        alert('没有可复制的图片链接');
        return;
      }
      
      navigator.clipboard.writeText(links.join('\n')).then(() => {
        alert(`已复制 ${links.length} 个链接到剪贴板！`);
      }).catch(err => {
        alert('复制失败，请手动选择复制: ' + err);
        console.error(err);
      });
    }

    // 更新统计信息
    function updateStats() {
      const total = allImages.length;
      const visible = currentFiltered.length;
      const selected = currentFiltered.filter(img => img.selected).length;
      
      document.getElementById('stats').innerHTML = `
        <span>总图片数: ${total}</span>
        <span>符合条件: ${visible}</span>
        <span>选中: ${selected}</span>
      `;
    }

    // 显示/隐藏加载状态
    function showLoading(show, message = '加载中...') {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
      document.getElementById('loadingText').textContent = message;
    }

    // 取消加载
    function cancelLoading() {
      loadingCanceled = true;
      if (currentLoadingProcess) {
        // 尝试中止fetch请求
        currentLoadingProcess.abort && currentLoadingProcess.abort();
      }
      showLoading(false);
      alert('操作已取消');
    }

    // 测试函数
    function testWechatUrl() {
      document.getElementById('urlInput').value = 'https://mp.weixin.qq.com/s/ssj4hnk95iLgo8RpA9E1QQ';
    }
  </script>
</body>
</html>
