<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高级图片管理工具 - 全能版</title>
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --light-bg: #f5f5f5;
      --dark-bg: #343a40;
      --text-color: #212529;
      --border-color: #ddd;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      color: var(--text-color);
      line-height: 1.6;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .config-box {
      background: var(--light-bg);
      padding: 15px;
      border-radius: 8px;
      flex: 1;
      min-width: 300px;
    }
    
    textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      font-family: inherit;
    }
    
    button {
      padding: 10px 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      margin: 5px 0;
    }
    
    button:hover {
      background: #0069d9;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: var(--secondary-color);
    }
    
    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .img-card {
      border: 2px solid var(--border-color);
      padding: 10px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .img-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .img-card.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(0,123,255,0.3);
    }
    
    .img-card.error {
      border-color: #dc3545;
    }
    
    .img-card img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }
    
    .checkbox {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .size-info {
      font-size: 12px;
      color: var(--secondary-color);
      margin-top: 8px;
      text-align: center;
    }
    
    .stats {
      margin: 15px 0;
      padding: 12px;
      background: var(--light-bg);
      border-radius: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .stats span {
      font-weight: bold;
      white-space: nowrap;
    }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }
    
    .progress-container {
      width: 80%;
      max-width: 500px;
      background: var(--dark-bg);
      border-radius: 10px;
      margin: 20px 0 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 20px;
      background: #28a745;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progressShine 2s infinite;
    }
    
    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .drop-area {
      border: 2px dashed var(--border-color);
      padding: 25px;
      text-align: center;
      margin: 10px 0;
      transition: all 0.3s;
      border-radius: 6px;
      background: rgba(255,255,255,0.5);
    }
    
    .drop-area.highlight {
      border-color: var(--primary-color);
      background: rgba(0,123,255,0.05);
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 15px;
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
    }
    
    .tab-container::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }
    
    .tab {
      padding: 10px 20px;
      background: #e9ecef;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    input[type="text"], input[type="number"] {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin: 5px 0;
      width: 80px;
    }
    
    label {
      margin-right: 10px;
      white-space: nowrap;
    }
    
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .mobile-only {
      display: none;
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        gap: 15px;
      }
      
      .config-box {
        width: 100%;
        min-width: auto;
      }
      
      #gallery {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats {
        flex-direction: column;
        gap: 8px;
      }
      
      .tab {
        padding: 8px 15px;
        font-size: 14px;
      }
      
      .mobile-only {
        display: block;
      }
      
      .desktop-only {
        display: none;
      }
      
      .actions {
        justify-content: space-between;
      }
      
      button {
        flex: 1;
        min-width: 120px;
      }
    }
    
    /* 小屏幕手机 */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      #gallery {
        grid-template-columns: 1fr;
      }
      
      .drop-area {
        padding: 15px;
      }
      
      .config-box {
        padding: 12px;
      }
    }
    
    /* 暗黑模式 */
    @media (prefers-color-scheme: dark) {
      :root {
        --light-bg: #343a40;
        --text-color: #f8f9fa;
        --border-color: #495057;
      }
      
      body {
        background: #212529;
      }
      
      .img-card {
        background: #2c3034;
      }
      
      textarea, input[type="text"], input[type="number"] {
        background: #495057;
        color: white;
        border-color: #6c757d;
      }
      
      .drop-area {
        background: rgba(73, 80, 87, 0.5);
      }
    }
  </style>
</head>
<body>
  <h2>高级图片管理工具</h2>
  <div class="stats" id="stats">
    <span>总图片数: 0</span>
    <span>符合条件: 0</span>
    <span>当前剩余: 0</span>
  </div>

  <div class="container">
    <div class="config-box">
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('html-tab')">HTML输入</div>
        <div class="tab" onclick="switchTab('url-tab')">URL输入</div>
        <div class="tab" onclick="switchTab('wechat-tab')">微信文章</div>
      </div>
      
      <div id="html-tab" class="tab-content active">
        <div class="drop-area" id="dropArea">
          <p>拖放HTML文件到这里或粘贴HTML代码</p>
          <textarea id="htmlInput" placeholder="粘贴完整的HTML内容到这里..."></textarea>
        </div>
        <button onclick="loadImages()">解析图片</button>
      </div>
      
      <div id="url-tab" class="tab-content">
        <input type="text" id="urlInput" placeholder="输入网页URL (如: https://example.com)" style="width: 100%; padding: 10px; margin: 10px 0;">
        <div class="actions">
          <button onclick="fetchFromUrl()">获取网页内容</button>
          <button class="secondary" onclick="testNormalUrl()">测试普通网页</button>
        </div>
        <p class="mobile-only">提示：部分网站可能需要手动复制内容</p>
      </div>
      
      <div id="wechat-tab" class="tab-content">
        <input type="text" id="wechatInput" placeholder="输入微信公众号文章URL (如: https://mp.weixin.qq.com/s/...)" style="width: 100%; padding: 10px; margin: 10px 0;">
        <div class="actions">
          <button onclick="fetchWechatArticle()">尝试获取</button>
          <button class="secondary" onclick="testWechatUrl()">测试微信文章</button>
        </div>
        <p>由于微信限制，建议：</p>
        <ol>
          <li>手动打开文章</li>
          <li>右键 → 查看网页源代码</li>
          <li>复制全部内容到HTML输入</li>
        </ol>
      </div>
    </div>
    
    <div class="config-box">
      <h3>筛选设置</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <label>最小宽度: <input type="number" id="minWidth" value="0" min="0"></label>
        <label>最小高度: <input type="number" id="minHeight" value="0" min="0"></label>
        <button onclick="applyFilter()">应用筛选</button>
      </div>
      
      <h3 style="margin-top: 15px;">图片属性设置</h3>
      <div style="margin-bottom: 15px;">
        <input type="text" id="attrInput" value="data-original,src,data-src" placeholder="例如: data-original,src" style="width: 100%; padding: 10px;">
        <small>多个属性用逗号分隔，将按顺序尝试获取</small>
      </div>
      
      <h3 style="margin-top: 15px;">操作</h3>
      <div class="actions">
        <button onclick="selectAll()">全选</button>
        <button onclick="deselectAll()">取消全选</button>
        <button onclick="deleteSelected()" style="background: #dc3545;">删除选中</button>
        <button onclick="copyResults()">复制结果</button>
      </div>
    </div>
  </div>

  <div id="gallery"></div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div id="loadingText" style="font-size: 18px; margin-bottom: 10px;">加载中...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="progressText" style="margin-top: 10px;">0/0</div>
    <button onclick="cancelLoading()" style="margin-top: 20px; background: #dc3545;">取消</button>
  </div>

  <script>
    let allImages = [];
    let currentFiltered = [];
    let loadingCanceled = false;
    let currentLoadingProcess = null;

    // 切换标签页
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // 设置拖放功能
    const dropArea = document.getElementById('dropArea');
    const htmlInput = document.getElementById('htmlInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.classList.add('highlight');
    }

    function unhighlight() {
      dropArea.classList.remove('highlight');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        const file = files[0];
        if (file.type === 'text/html' || file.name.endsWith('.html')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            htmlInput.value = e.target.result;
          };
          reader.readAsText(file);
        } else {
          alert('请上传HTML文件');
        }
      }
    }

    // 从URL获取网页内容
    async function fetchFromUrl() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('请输入有效的URL');
        return;
      }

      // 检查是否是微信文章
      if (url.includes('mp.weixin.qq.com')) {
        switchTab('wechat-tab');
        document.getElementById('wechatInput').value = url;
        alert('检测到微信公众号文章，已切换到微信文章标签');
        return;
      }

      showLoading(true, '正在获取网页内容...');
      loadingCanceled = false;
      
      try {
        // 使用更强大的请求方式模拟浏览器
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&callback=?`;
        
        currentLoadingProcess = fetch(proxyUrl, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
        });
        
        const response = await currentLoadingProcess;
        const data = await response.json();
        
        if (data.contents) {
          htmlInput.value = data.contents;
          switchTab('html-tab');
          await loadImages();
        } else {
          throw new Error('无法获取网页内容');
        }
      } catch (error) {
        if (!loadingCanceled) {
          alert('获取网页内容失败: ' + error.message);
          console.error(error);
          
          // 提供备选方案
          if (confirm('部分网站可能需要手动复制内容。是否要打开新窗口查看网页源代码？')) {
            window.open(url, '_blank');
          }
        }
      } finally {
        if (!loadingCanceled) {
          showLoading(false);
        }
        currentLoadingProcess = null;
      }
    }

    // 尝试获取微信文章（实际上很难绕过限制）
    async function fetchWechatArticle() {
      const url = document.getElementById('wechatInput').value.trim();
      if (!url.includes('mp.weixin.qq.com')) {
        alert('请输入有效的微信公众号文章URL');
        return;
      }

      showLoading(true, '正在尝试获取微信文章...');
      
      try {
        // 微信文章很难直接获取，这里只是演示
        alert('由于微信限制，无法直接获取文章内容。请手动复制HTML源代码。');
        window.open(url, '_blank');
      } catch (error) {
        alert('获取失败: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // 加载图片
    async function loadImages() {
      const html = htmlInput.value;
      if (!html) {
        alert('请输入HTML内容');
        return;
      }

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      allImages = [];
      currentFiltered = [];
      document.getElementById('gallery').innerHTML = '';
      
      // 获取要解析的属性
      const attrInput = document.getElementById('attrInput').value;
      const attributes = attrInput.split(',').map(attr => attr.trim()).filter(attr => attr);
      
      if (attributes.length === 0) {
        alert('请至少指定一个要解析的属性');
        return;
      }

      showLoading(true, '正在解析图片...');
      loadingCanceled = false;
      
      // 收集所有指定属性的图片URL
      let elements = [];
      attributes.forEach(attr => {
        elements = elements.concat(Array.from(doc.querySelectorAll(`[${attr}]`)));
      });
      
      const links = [...new Set(elements.map(el => {
        for (const attr of attributes) {
          if (el.hasAttribute(attr)) {
            return el.getAttribute(attr);
          }
        }
        return null;
      }).filter(url => url))];
      
      if (links.length === 0) {
        alert('没有找到符合条件的图片');
        showLoading(false);
        return;
      }

      // 更新进度条
      updateProgress(0, links.length);
      
      // 异步加载图片获取尺寸
      try {
        for (let i = 0; i < links.length; i++) {
          if (loadingCanceled) break;
          
          const url = links[i];
          try {
            await loadImageWithProgress(url, i, links.length);
          } catch (error) {
            console.error(`加载图片失败: ${url}`, error);
            allImages.push({
              url,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
          }
        }

        if (!loadingCanceled) {
          currentFiltered = allImages.slice();
          applyFilter();
        }
      } finally {
        showLoading(false);
      }
    }

    // 带进度条的图片加载
    function loadImageWithProgress(url, current, total) {
      return new Promise((resolve, reject) => {
        if (loadingCanceled) {
          reject(new Error('用户取消'));
          return;
        }

        const img = new Image();
        img.src = url;
        
        img.onload = () => {
          if (loadingCanceled) return;
          
          allImages.push({
            url,
            width: img.naturalWidth,
            height: img.naturalHeight,
            selected: false,
            error: false
          });
          updateProgress(current + 1, total);
          resolve();
        };
        
        img.onerror = () => {
          if (loadingCanceled) return;
          
          allImages.push({
            url,
            width: 0,
            height: 0,
            selected: false,
            error: true
          });
          updateProgress(current + 1, total);
          resolve();
        };
        
        // 设置超时
        setTimeout(() => {
          if (!img.complete && !loadingCanceled) {
            allImages.push({
              url,
              width: 0,
              height: 0,
              selected: false,
              error: true
            });
            updateProgress(current + 1, total);
            resolve();
          }
        }, 10000);
      });
    }

    // 更新进度条
    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `${current}/${total} (${percent}%)`;
      document.getElementById('loadingText').textContent = `正在加载图片... ${percent}%`;
    }

    // 渲染图片库
    function renderGallery(images) {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = images.map((img, index) => `
        <div class="img-card ${img.selected ? 'selected' : ''} ${img.error ? 'error' : ''}" 
             onclick="toggleSelect(${index}, event)">
          <input type="checkbox" class="checkbox" 
                 ${img.selected ? 'checked' : ''} 
                 onchange="toggleSelect(${index})">
          <img src="${img.url}" alt="缩略图" onerror="this.style.display='none'">
          <div class="size-info">
            ${img.width}x${img.height || '未知'}
            ${img.error ? '<span style="color:red">(加载失败)</span>' : ''}
          </div>
        </div>
      `).join('');
      updateStats();
    }

    // 应用筛选
    function applyFilter() {
      const minW = parseInt(document.getElementById('minWidth').value) || 0;
      const minH = parseInt(document.getElementById('minHeight').value) || 0;
      
      currentFiltered = allImages.filter(img => 
        img.width >= minW && img.height >= minH
      );
      renderGallery(currentFiltered);
    }

    // 切换选择状态
    function toggleSelect(index, event) {
      if (event) event.stopPropagation();
      currentFiltered[index].selected = !currentFiltered[index].selected;
      
      // 同步到总数据
      const targetUrl = currentFiltered[index].url;
      const mainIndex = allImages.findIndex(img => img.url === targetUrl);
      if (mainIndex >= 0) {
        allImages[mainIndex].selected = currentFiltered[index].selected;
      }
      
      renderGallery(currentFiltered);
    }

    // 全选/取消全选
    function selectAll() {
      currentFiltered.forEach(img => img.selected = true);
      allImages.forEach(img => {
        if (currentFiltered.some(fImg => fImg.url === img.url)) {
          img.selected = true;
        }
      });
      renderGallery(currentFiltered);
    }

    function deselectAll() {
      currentFiltered.forEach(img => img.selected = false);
      allImages.forEach(img => {
        if (currentFiltered.some(fImg => fImg.url === img.url)) {
          img.selected = false;
        }
      });
      renderGallery(currentFiltered);
    }

    // 删除选中项
    function deleteSelected() {
      const selectedUrls = currentFiltered
        .filter(img => img.selected)
        .map(img => img.url);
      
      if (selectedUrls.length === 0) {
        alert('请先选择要删除的图片');
        return;
      }
      
      if (!confirm(`确定要删除选中的 ${selectedUrls.length} 张图片吗？`)) {
        return;
      }
      
      allImages = allImages.filter(img => 
        !selectedUrls.includes(img.url)
      );
      applyFilter();
    }

    // 复制结果
    function copyResults() {
      const links = currentFiltered.map(img => img.url);
      if (links.length === 0) {
        alert('没有可复制的图片链接');
        return;
      }
      
      navigator.clipboard.writeText(links.join('\n')).then(() => {
        alert(`已复制 ${links.length} 个链接到剪贴板！`);
      }).catch(err => {
        alert('复制失败，请手动选择复制: ' + err);
        console.error(err);
      });
    }

    // 更新统计信息
    function updateStats() {
      const total = allImages.length;
      const visible = currentFiltered.length;
      const selected = currentFiltered.filter(img => img.selected).length;
      
      document.getElementById('stats').innerHTML = `
        <span>总图片数: ${total}</span>
        <span>符合条件: ${visible}</span>
        <span>选中: ${selected}</span>
      `;
    }

    // 显示/隐藏加载状态
    function showLoading(show, message = '加载中...') {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
      document.getElementById('loadingText').textContent = message;
    }

    // 取消加载
    function cancelLoading() {
      loadingCanceled = true;
      if (currentLoadingProcess) {
        // 尝试中止fetch请求
        currentLoadingProcess.abort && currentLoadingProcess.abort();
      }
      showLoading(false);
      alert('操作已取消');
    }

    // 测试函数
    function testNormalUrl() {
      document.getElementById('urlInput').value = 'https://example.com';
    }
    
    function testWechatUrl() {
      document.getElementById('wechatInput').value = 'https://mp.weixin.qq.com/s/ssj4hnk95iLgo8RpA9E1QQ';
    }
  </script>
</body>
</html>
